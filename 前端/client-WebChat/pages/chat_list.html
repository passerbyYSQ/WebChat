<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/common.css">
		
		<style type="text/css">
			#list .mui-media-body {
				padding-right: 28px;
			}
			.btn-group {
				margin-top: 8px !important;
				display: flex;
				justify-content: space-around;
			}
			.btn-group button {
				padding: 4px 20px;
			}
		</style>
	</head>
	
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">聊天列表</h1>
		</header>
		
		<div class="mui-content">
			<!-- <ul id="list" class="mui-table-view"> 
				<li class="mui-table-view-cell mui-collapse">
					<a class="mui-navigate-right" href="#">
						<img class="mui-media-object mui-pull-left" src="../imgs/face-cat.jpg">
						<div class="mui-media-body">
							<span>王小明王</span>
							<span class='mui-badge mui-badge-warning' style="padding: 2px 6px;">new</span>
							<p class="mui-pull-right">3秒前</p>
							<p class="mui-ellipsis"><b>[ 状态 ]</b> 向你发来了一个好友请求</p>
						</div>
					</a>
					<div class="mui-collapse-content">
						<p>你好啊，能认识一下你吗？？？？？你好啊，能认识一下你吗？？？？？你好啊，
						能认识一下你吗？？？？？你好啊，能认识一下你吗？？？？？
						</p>
						<div class="btn-group">
							<button type="button" class="mui-btn mui-btn-danger">拒绝</button>
							<button type="button" class="mui-btn mui-btn-grey">忽略</button>
							<button type="button" class="mui-btn mui-btn-green">同意</button>
						</div>
					</div>
				</li>
			</ul> -->
			
			<ul id="chatSnapshotList" class="mui-table-view">
				<!-- <li class="mui-table-view-cell mui-media">
					<a href="javascript:;">
						<img class="mui-media-object mui-pull-left" src="../imgs/face-cat.jpg">
						<div class="mui-media-body">
							幸福
							<p class="mui-ellipsis">能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>
						</div>
					</a>
				</li> -->
			</ul>
		</div>

	<body>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/chat.js"></script>
		
		<script type="text/javascript">
			mui.init();
			
			mui.plusReady(function () {
				// loadRequestList();
				// 注意不要在这里绑定按钮的点击事件，因为loadRequestList()是异步的
				
				// websocket初始化
				CHAT.init();
				
				// 加载聊天快照列表
				loadChatSnapshot();
			});
			
			// 渲染聊天快照列表
			function loadChatSnapshot() {
				var me = app.getUserGlobalInfo();
				var chatSnapshotList = app.getUserChatSnapshot(me.id);
				var html = "";
				for(var i=0; i<chatSnapshotList.length; i++) {
					var chatSnapshot = chatSnapshotList[i];
					var friend = app.getFriendFromContactList(chatSnapshot.friendId);
					html += ("<li id='ChatSnapshot_" + friend.userId +"' class='mui-table-view-cell mui-media'><a href='javascript:;'>" +
							"<img class='mui-media-object mui-pull-left' src='" + friend.faceImg + "'>" +
							"<div class='mui-media-body'>" + friend.username + "<p class='mui-ellipsis'>" + chatSnapshot.msg + "</p></div></a></li>");
				}
				var chatSnapshotBox = document.getElementById("chatSnapshotList");
				chatSnapshotBox.innerHTML = html;
			}
			
			// 更新快照列表
			function updateChatSnapshot(friendId, msg) { // 最后一条消息
				var friend = app.getFriendFromContactList(friendId);
				// 先移除旧快照
				document.getElementById("ChatSnapshot_" + friend.userId).remove();
				// 再在头部插入新快照
				var chatSnapshotBox = document.getElementById("chatSnapshotList"); 
				var html = ("<li id='ChatSnapshot_" + friend.userId +"' class='mui-table-view-cell mui-media'><a href='javascript:;'>" +
							"<img class='mui-media-object mui-pull-left' src='" + friend.faceImg + "'>" +
							"<div class='mui-media-body'>" + friend.username + "<p class='mui-ellipsis'>" + msg + "</p></div></a></li>");
				chatSnapshotBox.insertAdjacentHTML("afterbegin", html);
			}
			
			// 请求获取好友申请列表
			function loadRequestList() {
				app.ajax("friendRequest/list", {
					page: 1,
					count: 10
				}, function(res) {
					var list = res.data.list;
					joinHtml(list);
					
					// 加载数据之后，才绑定
					mui(".btn-group").on("tap", ".mui-btn", function() {
						var requestId = this.getAttribute("rid");
						var status = this.getAttribute("status");
						// app.showToast(requestId + ',' + status, "success");
						updateStatus(requestId, status);
					});
				}, "get");
			}
			
			function updateStatus(requestId, status) {
				app.ajax("friendRequest/process", {
					requestId: requestId,
					status: status
				}, function(res) {
					loadRequestList(); // 重新加载列表
				}, "post", null, function(res) {
					app.showToast(res.msg, "error");
					loadRequestList(); // 重新加载列表
				});
			}
			
			// 拼接好友请求列表
			function joinHtml(list) {
				var status = ['未处理', "已同意", "已忽略", "已拒绝"];
				var html = "";
				for(var i=0; i<list.length; i++) {
					var btnsHtml = "";
					var remind ="";
					if (list[i].status == 0) { // 尚未处理。需要显示操作按钮
						remind = " <span class='mui-badge mui-badge-warning' style='padding: 2px 6px;'>new</span>";
						btnsHtml = "<div class='btn-group'>" +
										"<button type='button' rid='"+ list[i].id +"' status='3' class='mui-btn mui-btn-danger'>拒绝</button>" +
										"<button type='button' rid='"+ list[i].id +"' status='2' class='mui-btn mui-btn-grey'>忽略</button>" +
										"<button type='button' rid='"+ list[i].id +"' status='1' class='mui-btn mui-btn-green'>同意</button></div>";					
					}
					html += ("<li class='mui-table-view-cell mui-collapse'>" +
								"<a class='mui-navigate-right' href='#'>" +
									"<img class='mui-media-object mui-pull-left' src='" + list[i].senderFaceImg + "'>" +
									"<div class='mui-media-body'>" +
										"<span>" + list[i].senderUsername + "</span>" + remind +
										"<p class='mui-pull-right'>" + app.formatDate(list[i].requestTime) + "</p>" +
										"<p class='mui-ellipsis'><b>[ " + status[list[i].status] + " ]</b> 向你发来了一个好友请求</p></div></a>" + 
										 "<div class='mui-collapse-content'>" +
											"<p>" + list[i].content + "</p>" +
											btnsHtml + "</div></li>");
							
				}
				
				var list = document.getElementById("list");
				list.innerHTML = html;
			}
			
		</script>
	</body>

</html>
